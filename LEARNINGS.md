# Learnings

### 2026-02-16
- [prompt_registry]: System prompts are centrally managed in `core/prompt_registry.py` via `PromptRegistry` class. Each prompt has an ID, name, description, category, module, and default value. The Settings page groups them by category. New modules need explicit registration here to appear in the UI.
- [prompt_registry]: Transform Data, AI Coder, and Model Comparison previously had no registered system prompts. Transform and Model Comparison use user-entered prompts via `st.text_area`; AI Coder builds prompts dynamically via `_build_ai_prompt()`. All three now have defaults registered.
- [session_state]: AI Coder uses `aic_` prefix, Manual Coder uses `mc_` prefix for all session state keys. Changing a key name (e.g. `aic_text_col` to `aic_text_cols`) requires updating init, save, load, config, all rendering, and all processing methods.
- [backward_compat]: When changing session save format (e.g. `text_col` string to `text_cols` list), the load function must handle both old and new formats. Pattern: `text_cols = data.get("text_cols"); if text_cols is None: old_col = data.get("text_col"); text_cols = [old_col] if old_col else []`.
- [streamlit_multiselect]: `st.multiselect` with a `key` parameter stores its value in session state under that key. The `default` parameter only applies on first render; subsequent renders use the session state value. This means changing `default` after first render has no effect.
- [coder_architecture]: Both AI Coder and Manual Coder follow identical patterns: `render_config()` returns `ToolConfig` with `config_data` dict, `render_results()` reads from session state. The immersive dialog and regular view both need updating when changing data access patterns.
- [text_display]: When displaying multiple columns in coders, plain text format uses `[ColName]: value` (for AI prompts), HTML format uses `<b>ColName:</b> value` (for UI display). Single column returns raw value without labels for backward compatibility.
- [testing]: All 488 tests pass via `pytest tests/ -x -q`. Tests are in `tests/` with unit tests under `tests/unit/`. The test suite covers coding tools, settings, automator, codebook, consensus, error classifier, LLM client, model comparison, models, and providers.
- [project_docs]: Project markdown docs live in root (`README.md`, `CONTRIBUTING.md`, `AUTOMATOR_UX_CHANGES.md`, `OPENROUTER_INTEGRATION.md`) and `docs/` (`system-prompts.md`, `sample-data-and-prompts.md`, `CONSENSUS_ENHANCED_JUDGE.md`). When adding features, update `docs/system-prompts.md` and `docs/sample-data-and-prompts.md` for prompt-related changes.
- [run_app]: The app runs via `.venv/bin/streamlit run app.py`. The `run.sh` script doesn't activate the venv, so running `streamlit` directly from shell fails with "command not found". Always use the venv path.
